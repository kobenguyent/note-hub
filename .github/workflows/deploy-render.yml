name: Deploy to Render

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/workflows/deploy-pages.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Flask App to Render

    steps:
      - uses: actions/checkout@v4

      - name: Verify deployment files
        run: |
          echo "‚úÖ Checking deployment files..."
          test -f Procfile && echo "‚úÖ Procfile found" || echo "‚ùå Procfile missing"
          test -f requirements.txt && echo "‚úÖ requirements.txt found" || echo "‚ùå requirements.txt missing"
          test -f runtime.txt && echo "‚úÖ runtime.txt found" || echo "‚ùå runtime.txt missing"
          test -f simple_app.py && echo "‚úÖ simple_app.py found" || echo "‚ùå simple_app.py missing"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies and run basic validation
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed successfully"
          python -c "import simple_app; print('‚úÖ Application imports successfully')"

      - name: Deploy to Render
        if: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "üöÄ Deploying to Render..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" -w "\nStatus: %{http_code}\n"
          echo ""
          echo "‚úÖ Deployment triggered!"
          echo "üìç Your app will be deployed at: https://note-hub.onrender.com"
          echo "‚è±Ô∏è  Deployment typically takes 2-5 minutes to complete"

      - name: Setup deployment instructions
        if: ${{ !secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "‚ö†Ô∏è  RENDER_DEPLOY_HOOK not configured"
          echo ""
          echo "üìã Setup Instructions:"
          echo "1. Go to https://render.com and sign up"
          echo "2. Create a new Web Service"
          echo "3. Connect your GitHub repository"
          echo "4. Set Build Command: pip install -r requirements.txt"
          echo "5. Set Start Command: gunicorn simple_app:app"
          echo "6. Add Environment Variables:"
          echo "   - NOTES_ADMIN_USERNAME: admin"
          echo "   - NOTES_ADMIN_PASSWORD: your-secure-password"
          echo "   - FLASK_SECRET: your-secret-key"
          echo "7. Copy the Deploy Hook URL from Render"
          echo "8. Go to GitHub Repo ‚Üí Settings ‚Üí Secrets ‚Üí New repository secret"
          echo "9. Name: RENDER_DEPLOY_HOOK, Value: paste the hook URL"
          echo ""
          echo "After setup, every push to main will auto-deploy! üéâ"

  notify:
    runs-on: ubuntu-latest
    name: Deployment Notification
    needs: deploy
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Render deployment workflow completed successfully!"
          else
            echo "‚ö†Ô∏è Render deployment workflow completed with warnings/errors"
          fi
