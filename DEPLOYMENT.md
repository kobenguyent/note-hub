# Deployment Guide for Note Hub

## ‚ö†Ô∏è CRITICAL: Database Persistence on Render

**Render uses ephemeral file systems by default.** Without a persistent disk, all your data (users, notes, tasks) will be **lost on every redeployment!**

### Solution: Persistent Disk Configuration

The `render.yaml` file is configured with a persistent disk:

```yaml
disk:
  name: notehub-data
  mountPath: /var/data
  sizeGB: 1
```

**IMPORTANT STEPS:**

1. **Verify in Render Dashboard:**

   - Go to your service ‚Üí "Disks" tab
   - Ensure the disk `notehub-data` is created and mounted at `/var/data`
   - If not, you may need to manually add it in the dashboard

2. **Check Database Location:**

   - Environment variable `NOTES_DB_PATH` must be set to `/var/data/notes.db`
   - This ensures the database is stored on the persistent disk

3. **Verify After Deployment:**
   - Visit: `https://your-app.onrender.com/admin/health`
   - Check the `likely_persistent` field is `true`
   - Verify no warnings about non-persistent storage

### Troubleshooting Data Loss

If you're still losing data after redeployment:

1. **Check Logs:** Look for database path in startup logs
2. **Verify Disk Mount:** Ensure `/var/data` exists and is writable
3. **Check Environment Variables:** Confirm `NOTES_DB_PATH=/var/data/notes.db`
4. **Manual Disk Addition:** In Render dashboard, manually add persistent disk if missing

---

## Deploy to Render (Recommended for Production)

Netlify hosts the Flask backend through **Netlify Functions** using `serverless-wsgi`. Every HTTP request is proxied to the serverless function described in `infra/netlify/functions/app.py` and orchestrated by `netlify.toml`.

### Step 1: Create Netlify Site

1. Install the CLI (optional but handy): `npm install -g netlify-cli`
2. Run `netlify init` inside the repo or connect the GitHub repo directly from the Netlify dashboard
3. When prompted for build settings, simply accept the defaults (the CLI/dashboard will read `netlify.toml`)

### Step 2: Configure Environment Variables

In Netlify ‚Üí Site settings ‚Üí Environment variables, add:

```
NOTES_ADMIN_USERNAME=admin
NOTES_ADMIN_PASSWORD=your-secure-password
FLASK_SECRET=your-secret-key-here
NOTES_DB_PATH=/tmp/notes.db
```

### Step 3: Enable Deploy Hooks (optional)

If you want GitHub Actions to trigger deployments, create a Build Hook (Site settings ‚Üí Build & deploy ‚Üí Build hooks) and copy the URL into the `NETLIFY_DEPLOY_HOOK` secret in GitHub.

### Step 4: Deploy

- **Manual:** `netlify deploy --prod`
- **Git-integrated:** Every push to `main` automatically triggers a build on Netlify
- **Via GitHub Action:** The `deploy-netlify.yml` workflow will POST to your build hook and Netlify will perform the deploy

Your app will be available at `https://<your-site>.netlify.app` once the first deploy succeeds.

---

## Deploy to Render

### Prerequisites

1. Create a [Render account](https://render.com)
2. Connect your GitHub repository to Render

### Deployment Steps

1. **Create Web Service:**

   - Click "New +" ‚Üí "Web Service"
   - Connect your GitHub repo: `thienng-it/note-hub`
   - Render will automatically detect `render.yaml`

2. **Verify Persistent Disk:**

   - Go to your service ‚Üí "Disks" tab
   - Ensure disk `notehub-data` is mounted at `/var/data`
   - This is CRITICAL for data persistence!

3. **Configure Environment Variables:**

   - `NOTES_ADMIN_USERNAME`: admin (or your choice)
   - `NOTES_ADMIN_PASSWORD`: (auto-generated or set your own)
   - `FLASK_SECRET`: (auto-generated by Render)
   - `NOTES_DB_PATH`: `/var/data/notes.db` (must match disk mount!)

4. **Deploy:**
   - Click "Create Web Service"
   - Wait for first deployment to complete
   - Visit `https://your-app.onrender.com`

### Post-Deployment Verification

**IMPORTANT:** After deployment, verify data persistence:

1. **Check Health Endpoint:**

   ```bash
   curl https://your-app.onrender.com/admin/health
   ```

2. **Verify Response:**

   ```json
   {
     "status": "healthy",
     "database": {
       "path": "/var/data/notes.db",
       "likely_persistent": true
     },
     "warnings": []
   }
   ```

3. **Test Data Persistence:**
   - Register a test account
   - Note down username/password
   - Trigger a redeployment (push to GitHub or manual redeploy)
   - Try logging in with test account
   - ‚úÖ If login works, data is persistent!
   - ‚ùå If login fails, disk may not be properly mounted

### Troubleshooting on Render

**Problem:** Data lost after redeployment

**Solutions:**

1. **Check Disk Mount:**

   ```bash
   # In Render Shell (Dashboard ‚Üí Shell)
   ls -la /var/data
   echo $NOTES_DB_PATH
   ```

2. **Verify Environment Variable:**

   - Must be: `NOTES_DB_PATH=/var/data/notes.db`
   - NOT: `/opt/render/project/data/notes.db` (ephemeral!)

3. **Check Logs for Database Path:**

   - Look for: `üóÑÔ∏è  Database file path: /var/data/notes.db`
   - Look for: `‚úÖ Database directory is writable`

4. **Manual Disk Creation:**
   - If disk doesn't exist: Dashboard ‚Üí Disks ‚Üí New Disk
   - Name: `notehub-data`
   - Mount Path: `/var/data`
   - Size: 1 GB

---

## Deploy to Netlify (Serverless - Data Not Persistent!)

**‚ö†Ô∏è WARNING:** Netlify Functions are stateless. SQLite database will NOT persist across invocations. Use only for testing or switch to external database (PostgreSQL).

### Step 1: Create Netlify Site

---

## Local Development

### Running Locally

1. **Install Dependencies:**

   ```bash
   pip install -r requirements.txt
   ```

2. **Set Environment Variables:**

   ```bash
   export NOTES_DB_PATH=./local_notes.db
   export NOTES_ADMIN_USERNAME=admin
   export NOTES_ADMIN_PASSWORD=YourSecurePassword123!
   export FLASK_SECRET=your-secret-key
   ```

3. **Run Development Server:**

   ```bash
   python scripts/dev_server.py
   ```

4. **Access Application:**
   - Open: `http://localhost:5000`
   - Login with admin credentials

---

## Production Best Practices

1. **Always Change Default Password:** First login, change admin password
2. **Use Strong Secret Key:** Never use default `FLASK_SECRET`
3. **Enable HTTPS:** Render provides this automatically
4. **Monitor Database Size:** Check `/admin/health` endpoint regularly
5. **Backup Database:** Download from Render Shell periodically

### Database Backup (Render)

```bash
# In Render Shell (Dashboard ‚Üí Shell)
cd /var/data
ls -lh notes.db
sqlite3 notes.db .dump > backup.sql
```

---

## Monitoring and Health Checks

### Health Check Endpoint

Visit `/admin/health` to verify system status. This endpoint shows:

- Database path and size
- Disk space availability
- Write permissions
- Persistence verification
- User count

### Example

```bash
curl https://your-app.onrender.com/admin/health | jq
```

---

## Quick Verification Checklist

After deployment, verify:

- [ ] `/admin/health` shows `"likely_persistent": true`
- [ ] No warnings in health check response
- [ ] Can create a test account
- [ ] Test account persists after redeployment
- [ ] Database path is `/var/data/notes.db`
- [ ] Disk shows in Render dashboard under "Disks" tab

---

- Database will be created at specified `NOTES_DB_PATH`
- For production, consider using PostgreSQL instead of SQLite
- Always change default admin password
- Use strong `FLASK_SECRET` value

## Monitoring

After deployment:

1. Test login with your credentials
2. Create a test note
3. Verify all features work (search, tags, dark mode)
4. Check logs for any errors

Need help? Check the main [README.md](README.md)
